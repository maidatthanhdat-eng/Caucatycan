<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Câu Cá Tỷ Cân - Santa Fishing Final Edition</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #1a1a1a; font-family: sans-serif; }
        #game-container { 
            position: absolute; 
            width: 1200px; 
            height: 846px; 
            background-image: url('map1.jpg'); 
            background-size: contain; 
            background-repeat: no-repeat; 
            background-position: center; 
        }

        #player {
            width: 100px; height: 160px; 
            position: absolute; 
            z-index: 10;
            background-image: url('player.png'); 
            background-size: contain; 
            background-repeat: no-repeat; 
            background-position: center;
        }

        #fishing-rod {
            width: 130px; height: 130px;
            position: absolute; 
            /* TỌA ĐỘ CẦN CÂU CHUẨN */
            top: -31px; 
            left: 77px; 
            transform-origin: 5% 95%; 
            background-image: url('RodOfTheDepths.png'); 
            background-size: contain; 
            background-repeat: no-repeat;
            z-index: 11;
            transition: transform 0.1s ease-out;
            transform: rotate(-15deg); 
        }

        .fishing-line {
            position: absolute; 
            background: #ffffff; 
            width: 1.5px; 
            z-index: 9;
            transform-origin: top center; 
            box-shadow: 0 0 3px #fff;
        }

        #controls-info { 
            position: fixed; top: 10px; left: 10px; 
            color: white; padding: 10px; 
            background: rgba(0, 0, 0, 0.7); 
            border-radius: 5px; z-index: 100; 
        }
    </style>
</head>
<body>
    <div id="controls-info">WASD: Di chuyển | SPACE: Quăng cần (Dây đã dính liền đầu cần)</div>
    <div id="game-container">
        <div id="player"><div id="fishing-rod"></div></div>
    </div>

    <script>
    const gameContainer = document.getElementById('game-container');
    const player = document.getElementById('player');
    const rod = document.getElementById('fishing-rod');

    let playerX = 800, playerY = 550;
    const speed = 6;
    let isFacingRight = true, isFishing = false;
    const keysPressed = {};

    // --- TỌA ĐỘ DÂY CÂU CHUẨN BẠN ĐÃ CHỈNH ---
    const LINE_PIVOT_X = 88;
    const LINE_PIVOT_Y = -23;

    // --- XỬ LÝ VA CHẠM ---
    const colCanvas = document.createElement("canvas");
    const colCtx = colCanvas.getContext("2d", {willReadFrequently: true});
    const colImg = new Image();
    colImg.src = "collision.png"; 

    colImg.onload = () => {
        colCanvas.width = 1200; colCanvas.height = 846;
        colCtx.drawImage(colImg, 0, 0, 1200, 846);
    };

    function canMove(x, y) {
        if (x < 0 || y < 0 || x >= 1100 || y >= 680) return false;
        const checkX = Math.floor(x + 50);
        const checkY = Math.floor(y + 155);
        try {
            const data = colCtx.getImageData(checkX, checkY, 1, 1).data;
            if (data[0] < 100) return false; 
        } catch(e) { return true; }
        return true;
    }

    function tossLine() {
        if (isFishing) return;
        isFishing = true;

        // Vụt cần câu
        rod.style.transform = "rotate(40deg)";

        // Tính toán điểm gốc dây dựa trên tọa độ X:88, Y:-23
        const pX = playerX + (isFacingRight ? LINE_PIVOT_X : (100 - LINE_PIVOT_X));
        const pY = playerY + LINE_PIVOT_Y;

        // Tọa độ ngọn cần khi đã quăng
        const angleRad = (isFacingRight ? 25 : 155) * Math.PI / 180;
        const tipX = pX + Math.cos(angleRad) * 120;
        const tipY = pY + Math.sin(angleRad) * 120;

        const line = document.createElement("div");
        line.className = "fishing-line";
        line.style.left = tipX + "px";
        line.style.top = tipY + "px";
        gameContainer.appendChild(line);

        let len = 0;
        const anim = setInterval(() => {
            len += 18;
            line.style.height = len + "px";
            line.style.transform = `rotate(${isFacingRight ? 1 : -1}deg)`;

            if(len > 350) {
                clearInterval(anim);
                setTimeout(() => {
                    line.remove();
                    rod.style.transform = "rotate(-15deg)";
                    isFishing = false;
                }, 700);
            }
        }, 20);
    }

    function gameLoop() {
        let velX = 0, velY = 0;
        if (!isFishing) {
            if (keysPressed['w']) velY = -speed;
            if (keysPressed['s']) velY = speed;
            if (keysPressed['a']) { velX = -speed; isFacingRight = false; }
            if (keysPressed['d']) { velX = speed; isFacingRight = true; }
            if (canMove(playerX + velX, playerY + velY)) {
                playerX += velX; playerY += velY;
            }
        }
        player.style.left = playerX + 'px';
        player.style.top = playerY + 'px';
        player.style.transform = isFacingRight ? 'scaleX(1)' : 'scaleX(-1)';

        const camX = (window.innerWidth / 2) - (playerX + 50);
        const camY = (window.innerHeight / 2) - (playerY + 80);
        gameContainer.style.transform = `translate(${camX}px, ${camY}px)`;
        requestAnimationFrame(gameLoop);
    }

    window.addEventListener('keydown', (e) => {
        keysPressed[e.key.toLowerCase()] = true;
        if (e.code === "Space") tossLine();
    });
    window.addEventListener('keyup', (e) => keysPressed[e.key.toLowerCase()] = false);
    
    gameLoop();
    </script>
</body>
</html>
